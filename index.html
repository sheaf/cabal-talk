<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Sam Derbyshire, Well-Typed">
  <title>A new architecture for Cabal</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="reveal.js/dist/reset.css">
  <link rel="stylesheet" href="reveal.js/dist/reveal.css">
  <style>
    .reveal .sourceCode {  /* see #7635 */
      overflow: visible;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="reveal.js/dist/theme/welltyped_theme.css" id="theme">
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">A new architecture for Cabal</h1>
  <p class="subtitle">Haskell Ecosystem Workshop</p>
  <p class="author">Sam Derbyshire, Well-Typed</p>
  <p class="date">June 7th, 2024</p>
</section>

<section class="slide level2">

<!--
Compile the HTML slides with Pandoc:

pandoc -t revealjs -s -o index.html cabal.md -V revealjs-url=reveal.js -V theme=welltyped_theme -V controlsTutorial=false -V controlsLayout=edges -V slideNumber='c/t' -V transition=slide -V width=1100

Custom theme in reveal.js/dist/themes/welltyped_theme.css
-->
</section>
<section id="plan" class="slide level2">
<h2>Plan</h2>
<ul>
<li>Cabal as a packaging framework: Common Architecture for Building
Applications and Libraries.</li>
<li>The <code>Setup.hs</code> interface and its shortcomings.</li>
<li>The <code>Cabal</code> library interface, and how to leverage it
(<code>cabal-install</code>, HLS).</li>
</ul>
<p class="indicator">
⭲
</p>
</section>
<section id="cabal-framework-and-library" class="slide level2">
<h2>Cabal: framework and library</h2>
<p>The <a
href="https://www.haskell.org/cabal/proposal/pkg-spec.pdf">Cabal
specification</a> was designed to allow Haskell tool authors to package
their code and share it with other developers.</p>
<p class="indicator">
⭲
</p>
</section>
<section id="section" class="slide level2">
<h2></h2>
<blockquote>
<p>The Haskell Package System (Cabal) has the following main goal:</p>
<ul>
<li>to specify a standard way in which a Haskell tool can be packaged,
so that it<br />
is easy for consumers to use it, or re-package it, regardless of the
Haskell<br />
implementation or installation platform.</li>
</ul>
</blockquote>
<p class="indicator">
⭲
</p>
</section>
<section id="section-1" class="slide level2">
<h2></h2>
<p>The Cabal concept of a package is a versioned unit of distribution in
source format, with enough metadata to allow it to be translated into
system packages by distribution managers.</p>
<p class="indicator">
⭲
</p>
</section>
<section id="section-2" class="slide level2">
<h2></h2>
<p>Each package must bundle some metadata, specified in a
<code>.cabal</code> file. Chiefly:</p>
<ul>
<li>the package name and version number,</li>
<li>its dependencies
(e.g. <code>base &gt;= 4.17 &amp;&amp; &lt; 4.21, lens ^&gt;= 5.3</code>),</li>
<li>what the package provides (libraries, exposed modules,
executables…),</li>
<li>how to build the package
(e.g. <code>build-type: Simple</code>).</li>
</ul>
<p class="indicator">
⭲
</p>
</section>
<section id="the-.cabal-file-format" class="slide level2">
<h2>The <code>.cabal</code> file format</h2>
<style>
.container{
  display: flex;
}
.col {
  flex: 1;
  margin: 10px;
}
</style>
<div class="container">
<div class="col">
<div class="sourceCode" id="cb1"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cabal-version: 3.0</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>name:        simple-pkg</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>version:     0.1.0.0</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>synopsis:    Simple package</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>category:    Graphics</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>license:     BSD-3-Clause</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>homepage:    https://simple.app</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>author:      Alice</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>maintainer:  alice@haskell.org</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>build-type:  Simple</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>data-dir:    data</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>data-files:  data1.txt</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>description: A simple package.</span></code></pre></div>
</div>
<div class="col">
<div class="sourceCode" id="cb2"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>flag debug</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  description: Debug mode.</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  default: False</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  manual:  True</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>common std</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    build-depends:</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        base</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            &gt;= 4.17  &amp;&amp; &lt; 4.21</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      , containers</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            &gt;= 0.6.1 &amp;&amp; &lt; 0.8</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    ghc-options:</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>      -Wall</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      -Wcompat</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    if flag(debug)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>      cpp-options:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>          -DDEBUG</span></code></pre></div>
</div>
<div class="col">
<div class="sourceCode" id="cb3"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>library</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    import:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        std</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    hs-source-dirs:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        src/lib</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    build-depends:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        bytestring</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>          &gt;= 0.10.1 &amp;&amp; &lt; 0.12</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    exposed-modules:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        Lib1, Lib2</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    other-modules:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        Lib1.Internal</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    autogen-modules:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        Paths_pkg</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    other-modules:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        Paths_pkg</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    default-language:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        Haskell2010</span></code></pre></div>
</div>
</div>
<p class="indicator">
⭲
</p>
</section>
<section id="section-3" class="slide level2">
<h2></h2>
<p>The Cabal library provides</p>
<ul>
<li>data types, parser and pretty printer for the <code>.cabal</code>
file format and the <code>hc-pkg</code> <em>installed package info</em>
format,</li>
<li>information about Haskell compilers (e.g. supported Haskell language
extensions),</li>
<li>the <code>Setup.hs</code> CLI,</li>
<li>how to build a single package.</li>
</ul>
<p class="indicator">
⭲
</p>
</section>
<section id="section-4" class="slide level2">
<h2></h2>
<p>A Haskell compiler <code>hc</code> supporting the Cabal specification
is required to provide a package registration program,
<code>hc-pkg</code>. The details of package registration are laid out in
the Cabal specification. The end result is that we store information
about installed libraries.</p>
<!--
TODO: give example of `ghc-pkg describe` and looking at `.conf` files.
-->
<div class="element: fragment">
<p>Note that, rather confusingly, one does not register packages with
this tool, only individual units.</p>
<p class="indicator">
⭲
</p>
</div>
</section>
<section id="the-setup-interface" class="slide level2">
<h2>The <code>Setup</code> interface</h2>
<p>To comply with the Cabal specification, the build system of a package
needs only implement the <code>Setup</code> command-line interface,
i.e. provide a <code>Setup</code> executable that supports invocations
of the form <code>./Setup &lt;cmd&gt;</code>.</p>
<div class="element: fragment">
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;"><code>&lt;cmd&gt;</code></th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>configure</code></td>
<td>resolve compiler, tools and dependencies</td>
</tr>
<tr class="even">
<td
style="text-align: right;"><code>build</code>/<code>haddock</code>/<code>repl</code></td>
<td>prepare sources and build/generate docs/open a session in the
interpreter</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>test</code>/<code>bench</code></td>
<td>run testsuites or benchmarks</td>
</tr>
<tr class="even">
<td
style="text-align: right;"><code>install</code>/<code>register</code></td>
<td>move files into an image dir or final location/register libraries
with the compiler</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>sdist</code></td>
<td>create an archive for distribution/packaging</td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>clean</code></td>
<td>clean local files (local package store, local build artifacts,
…)</td>
</tr>
</tbody>
</table>
<p class="indicator">
⭲
</p>
</div>
</section>
<section id="section-5" class="slide level2">
<h2></h2>
<p>In practice, the <code>./Setup configure</code> command takes a large
number of parameters (as represented in the <a
href="https://github.com/haskell/cabal/blob/3a8c69cb142e27caae5d754ac400636b3417b198/Cabal/src/Distribution/Simple/Setup/Config.hs#L88"><code>Cabal</code>
<code>ConfigFlags</code> data-type</a>). This configuration is preserved
for subsequent invocations, which usually only take a couple of
parameters
(e.g. <code>./Setup build -v2 --builddir=&lt;dir&gt;</code>).</p>
<p class="indicator">
⭲
</p>
</section>
<section id="section-6" class="slide level2">
<h2></h2>
<p>This interface can be used directly to build any package, by
executing the the following recipe:</p>
<ul>
<li>build the dependencies in dependency order,</li>
<li>to build each individual unit:
<ul>
<li><code>./Setup configure &lt;compName&gt; &lt;confArgs&gt;</code></li>
<li><code>./Setup build --builddir=&lt;buildDir&gt;</code></li>
<li><code>./Setup haddock --builddir=&lt;buildDir&gt; &lt;haddockArgs&gt;</code>
(optional, to generate documentation)</li>
<li><code>./Setup copy --builddir=&lt;buildDir&gt; --destDir=&lt;destDir&gt;</code>
(this makes executables available, e.g. for
<code>build-tool-depends</code>)</li>
<li><code>./Setup register --builddir=&lt;buildDir&gt; --gen-pkg-config=&lt;unitPkgRegFile&gt;</code>
(libraries only)</li>
<li><code>hc-pkg register --package-db=&lt;pkgDb&gt; &lt;unitPkgRegFile&gt;</code>
(libraries only)</li>
</ul></li>
</ul>
<div class="element: fragment">
<p>The tricky parts in the above are:</p>
<ul>
<li>passing appropriate arguments to <code>./Setup configure</code>,
e.g. <code>--package-db=&lt;pkgDb&gt;</code>,
<code>--cid=&lt;unitId&gt;</code> and
<code>--dependency=&lt;depPkgNm&gt;:&lt;depCompNm&gt;=&lt;depUnitId&gt;</code>
arguments,</li>
<li>constructing the correct environment for invoking
<code>./Setup</code>, e.g. adding appropriate
<code>build-tool-depends</code> executables in <code>PATH</code> and
defining the corresponding <code>&lt;buildTool&gt;_datadir</code>
environment variables.
<p class="indicator">
⭲
</p></li>
</ul>
</div>
</section>
<section id="section-7" class="slide level2">
<h2></h2>
One significant source of complexity in any tool (such as
<code>cabal-install</code>) which invokes <code>Setup</code> executables
is that the <code>Setup</code> interface is <strong>versioned</strong>:
as the Cabal specification evolves, so does the set of flags understood
by the <code>Setup</code> CLI.<br />
This means that, when provided with the <code>Setup</code> script for a
package, one needs to be careful about what arguments are passed to it;
see for instance how <code>cabal-install</code> handles this in <a
href="https://github.com/haskell/cabal/blob/3a8c69cb142e27caae5d754ac400636b3417b198/cabal-install/src/Distribution/Client/Setup.hs#L678-L849"><code>Distribution.Client.Setup.filterConfigureFlags</code></a>.
<p class="indicator">
⭲
</p>
</section>
<section id="section-8" class="slide level2">
<h2></h2>
<p>The recipe for building a package using <code>Setup</code> scripts
allows the <code>Setup</code> executables to be implemented in any way
the package author chooses; in a way, each package brings its own build
system.</p>
<p>This fundamentally limits what build systems such as
<code>cabal-install</code> or the Haskell Language Server can do in
multi-package projects, as one has to treat the build system of each
package as an opaque black box.</p>
<p>However, in practice, <strong>all</strong> packages use known build
systems:</p>
<ol type="1">
<li><code>build-type: Simple</code> (most packages). This means that
<code>./Setup configure</code> runs <a
href="https://github.com/haskell/cabal/blob/1b243bd0057c23ad7ed41f6ed60e4c9c77bbc9f0/Cabal/src/Distribution/Simple/Configure.hs#L323">the
<code>configure</code> function from the <code>Cabal</code> library</a>,
<code>./Setup build</code> runs <a
href="https://github.com/haskell/cabal/blob/1b243bd0057c23ad7ed41f6ed60e4c9c77bbc9f0/Cabal/src/Distribution/Simple/Build.hs#L100">the
<code>build</code> function from the <code>Cabal</code> library</a>,
etc.</li>
<li>A specific implementation of <code>build-type: Custom</code> using
<a
href="https://hackage.haskell.org/package/Cabal-3.12.0.0/docs/Distribution-Simple-UserHooks.html#t:UserHooks">the
<code>Cabal</code> <code>UserHooks</code> mechanism</a>, in which the
default logic (e.g. the <code>Cabal</code> <code>build</code> function)
is bracketed by custom hooks, e.g. custom configuration code run after
<code>Cabal</code> <code>configure</code>, or running an action to
generate module sources before running <code>Cabal</code>
<code>build</code>.</li>
</ol>
<div class="sourceCode" id="cb4"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  ( defaultMainWithHooks simpleUserHooks )</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    { confHook <span class="ot">=</span> \ ( gpd, hbi ) cfgFlags <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        gpd&#39; <span class="ot">&lt;-</span> customPreConfHook gpd cfgFlags</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        confHook simpleUserHooks ( gpd&#39;, hbi ) cfgFlags</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p class="indicator">
⭲
</p>
</section>
<section id="example-singletons-base" class="slide level2">
<h2>Example (<code>singletons-base</code>)</h2>
<p>See <a
href="https://github.com/sheaf/cabal-talk/blob/master/examples/custom/singletons-base/Setup.hs">the
<code>Setup.hs</code> file for <code>singletons-base</code></a>.</p>
<p class="indicator">
⭲
</p>
</section>
<section id="section-9" class="slide level2">
<h2></h2>
<p>This motivates the desire for a <strong>Haskell library
interface</strong> for customising the build system of a package. This
would allow introspection by build systems, and allow a gradual
restructuring of <code>cabal-install</code> away from the
<code>Setup</code> command-line interface, which has grown unwieldy due
the needs of package managers.</p>
<div class="element: fragment">
<p>What’s required is then:</p>
<ul>
<li>to provide a library interface to add hooks around these phases, so
that packages with <code>build-type: Custom</code> can be migrated to
use a library interface,</li>
<li>make use of this library interface in <code>cabal-install</code>, as
opposed to going through the <code>Setup</code> CLI.</li>
</ul>
<p class="indicator">
⭲
</p>
</div>
</section>
<section id="setup-hooks" class="slide level2">
<h2>Setup hooks</h2>
<p>The <code>Hooks</code> build-type provides a new way to customise how
a package is built: use the <code>Cabal</code> library, but with custom
hooks that augment (but don’t override) what the <code>Cabal</code>
library does.</p>
<ul>
<li><a
href="https://github.com/haskellfoundation/tech-proposals/blob/main/rfc/060-replacing-cabal-custom-build.md">Haskell
Foundation Tech RFC #60</a>,</li>
<li><a
href="https://sheaf.github.io/cabal-talk/docs/Cabal-hooks-0.1-inplace/Distribution-Simple-SetupHooks.html"><code>Cabal-hooks</code>
Haddocks</a> <a
href="https://hackage.haskell.org/package/Cabal-hooks/docs/Distribution-Simple-SetupHooks.html">(Hackage)</a>,</li>
<li><a
href="https://gitlab.haskell.org/mpickering/hooks-setup-testing">Cabal
Hooks overlay</a>.</li>
</ul>
<p class="indicator">
⭲
</p>
</section>
<section id="setup-hooks-in-practice" class="slide level2">
<h2>Setup hooks in practice</h2>
<pre class="cabal"><code>cabal-version: 3.14
...
build-type: Hooks
...

custom-setup
  setup-depends:
    base        &gt;= 4.18 &amp;&amp; &lt; 5,
    Cabal-hooks &gt;= 0.1  &amp;&amp; &lt; 0.2</code></pre>
<p class="indicator">
⭲
</p>
</section>
<section id="section-10" class="slide level2">
<h2></h2>
<div class="sourceCode" id="cb6"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">SetupHooks</span> <span class="kw">where</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Cabal-hooks</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Distribution.Simple.SetupHooks</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ot">setupHooks ::</span> <span class="dt">SetupHooks</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>setupHooks <span class="ot">=</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  noSetupHooks</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    { configureHooks <span class="ot">=</span> myConfigureHooks</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    , buildHooks <span class="ot">=</span> myBuildHooks }</span></code></pre></div>
<p class="indicator">
⭲
</p>
</section>
<section id="configure-hooks" class="slide level2">
<h2>Configure hooks</h2>
<p>There are three hooks into the configure phase:</p>
<ol type="1">
<li>Package-wide pre-configure.<br />
<code>type PreConfPackageHook = PreConfPackageInputs -&gt; IO PreConfPackageOutputs</code></li>
<li>Package-wide post-configure.<br />
<code>type PostConfPackageHook = PostConfPackageInputs -&gt; IO ()</code></li>
<li>Per-component pre-configure.<br />
<code>type PreConfComponentHook = PreConfComponentInputs -&gt; IO PreConfComponentOutputs</code></li>
</ol>
<div class="element: fragment">
<ol type="1">
<li><p>can be used for custom <code>./configure</code>-style logic,
e.g. configuring programs for use when building the package that don’t
fit into the framework of Cabal’s <code>build-tool-depends</code>
(e.g. because they require custom logic for parsing their version
number).</p></li>
<li><p>can be used to write custom package-wide information to disk, to
be consumed by (3).</p></li>
<li><p>can be used to modify individual components, e.g. adding exposed
modules or specifying flags to be used when building the
component.</p></li>
</ol>
<p class="indicator">
⭲
</p>
</div>
</section>
<section id="configuring-a-custom-preprocessor" class="slide level2">
<h2>Configuring a custom preprocessor</h2>
<p>The configure hooks of the <a
href="https://github.com/sheaf/cabal-talk/blob/master/examples/hooks/custom-preproc/SetupHooks.hs"><code>custom-preproc</code></a>
example.</p>
<p class="indicator">
⭲
</p>
</section>
<section id="modifying-individual-components" class="slide level2">
<h2>Modifying individual components</h2>
<p>The configure hooks of the <a
href="https://github.com/sheaf/cabal-talk/blob/master/examples/hooks/system-info/SetupHooks.hs"><code>system-info</code></a>
example.</p>
<p class="indicator">
⭲
</p>
</section>
<section id="pre-build-rules" class="slide level2">
<h2>Pre-build rules</h2>
<p>The general mechanism for preparing source files for compilation is
that of <a
href="https://sheaf.github.io/cabal-talk/docs/Cabal-hooks-0.1-inplace/Distribution-Simple-SetupHooks.html#t:Rules"><strong>pre-build
rules</strong></a><a
href="https://hackage.haskell.org/package/Cabal-hooks/docs/Distribution-Simple-SetupHooks.html#t:Rules">(Hackage)</a>.</p>
<div class="element: fragment">
<p>Thinking in terms of custom pre-processors: - each rule is a
pre-processor invocation with specific arguments, - the collection of
all custom preprocessors is statically known.</p>
</div>
</section>
<section id="example-singletons-base-using-hooks" class="slide level2">
<h2>Example: <code>singletons-base</code>, using <code>Hooks</code></h2>
<p>The pre-build rules of the <a
href="https://github.com/sheaf/cabal-talk/blob/master/examples/hooks/singletons-base/SetupHooks.hs"><code>singletons-base</code></a>
example.</p>
<p class="indicator">
⭲
</p>
</section>
<section id="example-custom-preprocessors" class="slide level2">
<h2>Example: custom preprocessors</h2>
<p>The pre-build rules of the <a
href="https://github.com/sheaf/cabal-talk/blob/master/examples/hooks/custom-preproc/SetupHooks.hs"><code>custom-preproc</code></a>
example (<code>myPreBuildRules</code>).</p>
<p class="indicator">
⭲
</p>
</section>
<section id="leveraging-the-library-interface" class="slide level2">
<h2>Leveraging the library interface</h2>
<p>We saw above how to migrate packages with custom build logic to use
<code>build-type: Hooks</code>, adding a layer of customisation to the
Cabal library interface. This allows all kinds of packages to be built
directly with a library interface, without going through the
<code>Setup</code> CLI.</p>
</section>
<section id="hooks-exe-the-external-hooks-executable"
class="slide level2">
<h2>hooks-exe: the external hooks executable</h2>
<p>To integrate packages with <code>build-type: Hooks</code> through a
library interface, we compile the <code>SetupHooks</code> module into a
separate executable with which we communicates via the CLI.</p>
<!--
TODO: we railed against the CLI of Setup.hs... so why is this CLI OK?
-->
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hooks-exe</span> <span class="op">&lt;</span>inputHandle<span class="op">&gt;</span> <span class="op">&lt;</span>outputHandle<span class="op">&gt;</span> <span class="op">&lt;</span>hookName<span class="op">&gt;</span></span></code></pre></div>
<p><em>Note:</em> Uses new <code>CommunicationHandle</code> API from <a
href="https://hackage.haskell.org/package/process-1.6.20.0/docs/System-Process-CommunicationHandle.html"><code>process</code></a></p>
</section>
<section id="versioning" class="slide level2">
<h2>Versioning</h2>
<p>More specifically, the question is: what do we do when
<code>cabal-install</code> is linked against a specific version of the
<code>Cabal</code> library (say <code>3.16.1.0</code>) that is
incompatible with the <code>Cabal</code> version required by a package
with <code>build-type: Hooks</code> (e.g. the package declares
<code>setup-depends: Cabal == 3.14.*</code> )?</p>
</section>
<section id="structured" class="slide level2">
<h2>Structured</h2>
<p>As a first line of defense, we use <a
href="https://hackage.haskell.org/package/Cabal-syntax-3.12.0.0/docs/Distribution-Utils-Structured.html"><code>Cabal</code>’s
<code>Structured</code> mechanism</a>, which ensures that both sides of
the IPC channel agree on the <code>Binary</code> instances used for
serialisation and deserialisation.</p>
</section>
<section id="private-dependencies" class="slide level2">
<h2>Private dependencies</h2>
<p>To provide compatibility between different <code>Cabal</code> library
versions, we propose to use <strong>private dependencies</strong>.</p>
<div class="element: fragment">
<p><code>cabal-install</code> would be linked against multiple versions
of the <code>Cabal</code> library, and would come bundled with internal
adapter functions, e.g.:</p>
</div>
<div class="element: fragment">
<div class="sourceCode" id="cb8"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>project <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">16</span>] <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">14</span>] <span class="op">@</span><span class="dt">LocalBuildInfo</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Cabal.V3_16.LocalBuildInfo</span> <span class="ot">-&gt;</span> <span class="dt">Cabal.V3_14.LocalBuildInfo</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>project <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">16</span>] <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">14</span>] <span class="op">@</span><span class="dt">Component</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Cabal.V3_16.Component</span> <span class="ot">-&gt;</span> <span class="dt">Cabal.V3_14.Component</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>project <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">16</span>] <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">14</span>] <span class="op">@</span><span class="dt">PreConfComponentInputs</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Cabal.V3_16.PreConfComponentInputs</span> <span class="ot">-&gt;</span> <span class="dt">Cabal.V3_14.PreConfComponentInputs</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>inject <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">14</span>] <span class="op">@</span>[<span class="dv">3</span>,<span class="dv">16</span>] <span class="op">@</span><span class="dt">PreConfComponentOutputs</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Cabal.V3_14.PreConfComponentOutputs</span> <span class="ot">-&gt;</span> <span class="dt">Cabal.V3_16.PreConfComponentOutputs</span></span></code></pre></div>
<p class="indicator">
⭲
</p>
</div>
</section>
<section id="hooks-exe-pre-build-rules" class="slide level2">
<h2>hooks-exe: pre-build rules</h2>
<p>Pre-build rules are a bit more complex, especially as they are
involved in recompilation checking. The external hooks executable
supports three queries:</p>
<ul>
<li>ask for all known rules using the <code>preBuildRules</code>
hook,<br />
this returns a value of type <code>Map RuleId RuleBinary</code>;</li>
<li>run a dynamic dependency computation, this returns additional edges
to the build graph of pre-build rules as well as extra arguments to be
passed to the rule in order to execute it;</li>
<li>execute a rule (e.g. run a pre-processor).</li>
</ul>
<p>For recompilation checking, the parent build system keeps track of
the most recent set of rules <code>Map RuleId RuleBinary</code>. The
build system must then ensure the rules are <strong>up-to-date</strong>,
and, when that is the case, it must must execute of all the (demanded)
<strong>stale rules</strong>.</p>
<p>The set of rules as a whole is considered
<strong>out-of-date</strong> precisely when any one of the following
conditions apply:</p>
<dl>
<dt>
O1
</dt>
<dd>
there was a monitored change in the files and directories monitored by
the rules,
</dd>
<dt>
O2
</dt>
<dd>
the environment passed to the computation of rules has changed.
</dd>
</dl>
<p>If the rules are out-of-date, the build system is expected to re-run
the computation that computes all rules.<br />
After this re-computation of the set of all rules, we match up new rules
with old rules, by <code>RuleId</code>. A rule is then considered
<strong>stale</strong> if any of following conditions apply:</p>
<dl>
<dt>
N
</dt>
<dd>
the rule is new (and thus has never been executed), or
</dd>
<dt>
S
</dt>
<dd>
the rule matches with an old rule, and either:
<dl>
<dt>
S1
</dt>
<dd>
a file dependency of the rule has been modified/created/deleted, or a
(transitive) rule dependency of the rule is itself stale, or
</dd>
<dt>
S2
</dt>
<dd>
the rule is different from the old rule, e.g. the argument stored in the
rule command has changed, or the pointer to the action to run the rule
has changed. (This is determined using the <code>Eq RuleBinary</code>
instance.)
</dd>
</dl>
</dd>
</dl>
<p>A stale rule becomes no longer stale once we run its associated
action (which will require running the rule’s dynamic dependency
computation first, if it has one). The build system is responsible for
re-running the actions associated with each demanded stale rule, in
dependency order (including dynamic dependencies).</p>
</section>
<section id="additional-challenges" class="slide level2">
<h2>Additional challenges</h2>
<p><code>Distribution.Client.SetupWrapper.invoke</code>:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> loggingHandle <span class="ot">=</span> <span class="kw">case</span> useLoggingHandle options <span class="kw">of</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Inherit</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> hdl <span class="ot">-&gt;</span> <span class="dt">UseHandle</span> hdl</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>      cp <span class="ot">=</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        (proc path args)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>          { Process.cwd <span class="ot">=</span> <span class="fu">fmap</span> getSymbolicPath <span class="op">$</span> useWorkingDir options</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>          , Process.env <span class="ot">=</span> env</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>          , Process.std_out <span class="ot">=</span> loggingHandle</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>          , Process.std_err <span class="ot">=</span> loggingHandle</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>          , Process.delegate_ctlc <span class="ot">=</span> isInteractive options</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  maybeExit <span class="op">$</span> rawSystemProc verbosity cp</span></code></pre></div>
<div class="element: fragment">
<ul>
<li>working directory (<a
href="https://github.com/haskell/cabal/commit/7b9058328e162a4cb707b5d5b25cd1d2df66680e"><code>7b90583</code></a>),</li>
<li>environment variables (<a
href="https://github.com/haskell/cabal/commit/ee11ac6c7badc452def79116729bd16aea15c0df"><code>ee11ac6</code></a>),</li>
<li>logging handle <a
href="https://github.com/haskell/cabal/issues/9987"><code>Cabal</code>
#9987</a>.</li>
</ul>
</div>
</section>
<section id="make-custom-a-separate-component" class="slide level2">
<h2>Make Custom a separate component</h2>
<p>Another piece of further work is that packages that make use of a
custom setup stanza (which currently includes <code>Custom</code> and
<code>Hooks</code> build types) are treated as a whole, not benefiting
from the “per component” logic in <code>cabal-install</code> and thus
being locked out of certain features such as multiple sublibraries. This
is a long-standing flaw in the implementation of
<code>cabal-install</code>. The task is up for grabs at <a
href="https://github.com/haskell/cabal/issues/9986"><code>Cabal</code>
#9986</a>.</p>
</section>
<section id="hls-integration" class="slide level2">
<h2>HLS integration</h2>
<p>Finally, there is the task of integrating the fine-grained
recompilation logic for pre-build rules outlined in <a
href="#/hooks-exe-pre-build-rules">§ hooks-exe: pre-build rules</a> into
the Haskell Language Server.</p>
</section>
<section id="end-of-slides" class="slide level2">
<h2>End of slides</h2>
<p>Slides available online: <a
href="https://sheaf.github.io/cabal-talk">sheaf.github.io/cabal-talk</a>.</p>
<p>Cabal tickets (in increasing order of difficulty):</p>
<ul>
<li>Monitoring directory-recursive file globs in
<code>cabal-install</code>: <a
href="https://github.com/haskell/cabal/issues/10064"><code>Cabal</code>
#10064</a></li>
<li>Add support for logging handles to <code>Cabal</code>: <a
href="https://github.com/haskell/cabal/issues/9987"><code>Cabal</code>
#9987</a>.</li>
<li>Make setup a separate component: <a
href="https://github.com/haskell/cabal/issues/9986"><code>Cabal</code>
#9986</a>.</li>
</ul>
</section>
    </div>
  </div>

  <script src="reveal.js/dist/reveal.js"></script>

  <!-- reveal.js plugins -->
  <script src="reveal.js/plugin/notes/notes.js"></script>
  <script src="reveal.js/plugin/search/search.js"></script>
  <script src="reveal.js/plugin/zoom/zoom.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
        // Display controls in the bottom right corner
        controls: true,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: false,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: true,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'default',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: true,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'fade',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1100,

        // reveal.js plugins
        plugins: [
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    </body>
</html>
